name: Build AthenaOS ARM64 ISO

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version (e.g., v1.0.0)'
        required: false
        default: ''

env:
  FEDORA_VERSION: 40
  ISO_NAME: athenaos-arm64

jobs:
  build-arm64-iso:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx and ARM64 emulation
      uses: docker/setup-buildx-action@v3
      with:
        platforms: linux/amd64,linux/arm64

    - name: Set up QEMU for ARM64 emulation
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm64

    - name: Verify Docker and ARM64 support
      run: |
        echo "üîç Verifying Docker installation and ARM64 support"
        echo "Host architecture: $(uname -m)"
        echo "Docker version: $(docker --version)"
        echo "Docker buildx version: $(docker buildx version)"
        echo "Available platforms:"
        docker buildx ls
        echo "Testing ARM64 emulation:"
        docker run --rm --platform linux/arm64 alpine:latest uname -m
        
    - name: Set version variables
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.release_version }}" ]]; then
          VERSION="${{ github.event.inputs.release_version }}"
        elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION="${{ github.ref_name }}"
        else
          VERSION="$(date +%Y%m%d)-$(echo ${{ github.sha }} | cut -c1-7)"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "iso_filename=${ISO_NAME}-${VERSION}.iso" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"
        
    - name: Create build container
      run: |
        cat << 'EOF' > Dockerfile
        FROM fedora:${{ env.FEDORA_VERSION }}
        
        # Install required packages for building live media
        RUN dnf update -y && \
            dnf install -y \
                lorax \
                anaconda \
                anaconda-tui \
                livemedia-creator \
                pykickstart \
                python3-pylorax \
                systemd \
                glibc-all-langpacks \
                qemu-kvm \
                libvirt \
                virt-install \
                libguestfs-tools \
                xorriso \
                syslinux \
                git \
                wget \
                curl \
                file \
                coreutils && \
            dnf clean all
            
        # Set up working directory
        WORKDIR /workspace
        
        # Copy kickstart and configuration files
        COPY . .
        
        # Make sure src files are in the right place
        RUN mkdir -p /etc/pacman.d && \
            cp src/athena-mirrorlist /etc/pacman.d/ && \
            cp src/pacman.conf /etc/pacman.conf && \
            cp src/*.gpg /etc/pacman.d/ && \
            cp src/*-trusted /etc/pacman.d/ && \
            cp src/*-revoked /etc/pacman.d/
            
        VOLUME ["/output"]
        EOF
        
        echo "Building Docker image for ARM64..."
        docker build --platform linux/arm64 -t athenaos-builder .
        
    - name: Build ARM64 ISO
      run: |
        mkdir -p ./output
        
        # Create the build script
        cat << 'EOF' > build-iso.sh
        #!/bin/bash
        set -e
        
        echo "üöÄ Starting AthenaOS ARM64 ISO build..."
        echo "üìã Build Information:"
        echo "   Fedora version: ${{ env.FEDORA_VERSION }}"
        echo "   Target architecture: aarch64"
        echo "   Container architecture: $(uname -m)"
        echo "   ISO filename: ${{ steps.version.outputs.iso_filename }}"
        echo ""
        
        # Create output directory
        mkdir -p /output
        
        # Verify kickstart file
        echo "üîç Validating kickstart file..."
        if ! pykickstart --version F${{ env.FEDORA_VERSION }} athena-iso.ks; then
            echo "‚ùå ERROR: Kickstart file validation failed"
            exit 1
        fi
        echo "‚úÖ Kickstart file is valid"
        
        # Check available space
        echo "üìä Available disk space:"
        df -h /output
        
        # Build the ISO using livemedia-creator
        echo ""
        echo "üèóÔ∏è  Building live media (this may take a while)..."
        livemedia-creator \
            --ks athena-iso.ks \
            --no-virt \
            --resultdir /output \
            --project "AthenaOS ARM64" \
            --make-iso \
            --volid "AthenaOS-ARM64" \
            --iso-only \
            --iso-name "${{ steps.version.outputs.iso_filename }}" \
            --releasever ${{ env.FEDORA_VERSION }} \
            --title "AthenaOS ARM64" \
            --logfile /output/build.log \
            --timeout 7200 \
            --tmp /tmp
            
        # Verify the ISO was created
        echo ""
        echo "üîç Checking build results..."
        if [ -f "/output/${{ steps.version.outputs.iso_filename }}" ]; then
            echo "‚úÖ ISO build successful!"
            echo "üìÅ Output directory contents:"
            ls -lh /output/
            echo ""
            echo "üìä ISO details:"
            echo "   Size: $(du -h /output/${{ steps.version.outputs.iso_filename }} | cut -f1)"
            echo "   File type: $(file /output/${{ steps.version.outputs.iso_filename }})"
        else
            echo "‚ùå ERROR: ISO build failed"
            echo "üìÅ Output directory contents:"
            ls -la /output/ || echo "No output directory"
            echo ""
            echo "üìú Build log (last 50 lines):"
            tail -50 /output/build.log 2>/dev/null || echo "No build log found"
            exit 1
        fi
        EOF
        
        chmod +x build-iso.sh
        
        # Run the build in container with optimized settings for Ubuntu
        echo "üê≥ Starting build container..."
        docker run --rm \
            --platform linux/arm64 \
            -v "$(pwd)":/workspace \
            -v "$(pwd)/output":/output \
            --privileged \
            --memory=8g \
            --cpus=4 \
            athenaos-builder \
            /workspace/build-iso.sh
            
    - name: Verify ISO build
      run: |
        if [ -f "./output/${{ steps.version.outputs.iso_filename }}" ]; then
          echo "‚úÖ ISO build successful!"
          echo "üìÅ ISO location: ./output/${{ steps.version.outputs.iso_filename }}"
          echo "üìä ISO size: $(du -h ./output/${{ steps.version.outputs.iso_filename }} | cut -f1)"
          echo "üîç ISO details:"
          file "./output/${{ steps.version.outputs.iso_filename }}"
        else
          echo "‚ùå ISO build failed!"
          echo "üìã Available files in output:"
          ls -la ./output/ || echo "No output directory"
          echo "üìú Build log:"
          cat ./output/build.log 2>/dev/null || echo "No build log available"
          exit 1
        fi
        
    - name: Generate checksums
      run: |
        cd output
        echo "‚úÖ Generating checksums..."
        sha256sum "${{ steps.version.outputs.iso_filename }}" > "${{ steps.version.outputs.iso_filename }}.sha256"
        md5sum "${{ steps.version.outputs.iso_filename }}" > "${{ steps.version.outputs.iso_filename }}.md5"
        echo "üìã Checksums generated:"
        cat "${{ steps.version.outputs.iso_filename }}.sha256"
        cat "${{ steps.version.outputs.iso_filename }}.md5"
        
    - name: Cleanup Docker resources
      if: always()
      run: |
        echo "üßπ Cleaning up Docker resources..."
        docker system prune -f || true
        
    - name: Upload ISO artifact
      uses: actions/upload-artifact@v4
      with:
        name: athenaos-arm64-iso-${{ steps.version.outputs.version }}
        path: |
          output/${{ steps.version.outputs.iso_filename }}
          output/${{ steps.version.outputs.iso_filename }}.sha256
          output/${{ steps.version.outputs.iso_filename }}.md5
          output/build.log
        retention-days: 30
        
    - name: Create Release
      if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: AthenaOS ARM64 ${{ steps.version.outputs.version }}
        body: |
          # AthenaOS ARM64 Release ${{ steps.version.outputs.version }}
          
          This is an automated build of AthenaOS for ARM64 architecture.
          
          ## üèóÔ∏è Build Information
          - **Architecture**: ARM64 (aarch64)
          - **Base**: Fedora ${{ env.FEDORA_VERSION }}
          - **Build Date**: ${{ github.run_id }}
          - **Commit**: ${{ github.sha }}
          
          ## üì• Download
          - **ISO File**: `${{ steps.version.outputs.iso_filename }}`
          - **SHA256**: `${{ steps.version.outputs.iso_filename }}.sha256`
          - **MD5**: `${{ steps.version.outputs.iso_filename }}.md5`
          
          ## ‚ö†Ô∏è Important Notes
          - This is an experimental ARM64 build
          - Test thoroughly before production use
          - Report issues on the GitHub repository
          
          ## üöÄ Installation
          1. Download the ISO file
          2. Verify checksums
          3. Flash to USB or burn to DVD
          4. Boot on ARM64 device
          
        files: |
          output/${{ steps.version.outputs.iso_filename }}
          output/${{ steps.version.outputs.iso_filename }}.sha256
          output/${{ steps.version.outputs.iso_filename }}.md5
        draft: false
        prerelease: ${{ !startsWith(github.ref, 'refs/tags/') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
